name: PyQPanda Algorithm CI/CD Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # 1. Linux å¹³å°æž„å»º (Python 3.10, 3.11, 3.12)
  linux-build-310:
    name: Linux Build (Python 3.10)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
    
    - name: Build Linux wheel (Python ${{ matrix.python-version }})
      run: |
        set -e
        echo "========== å¼€å§‹æž„å»º Linux Python ${{ matrix.python-version }} åŒ… =========="
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd pyqpanda-algorithm
        
        # åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
        python -m venv /tmp/alg-build-linux-${{ matrix.python-version }}-venv
        source /tmp/alg-build-linux-${{ matrix.python-version }}-venv/bin/activate
        
        # æ¸…ç†æ—§æž„å»º
        rm -rf build dist *.egg-info 2>/dev/null || true
        
        # å®‰è£…æž„å»ºå·¥å…·
        pip install wheel setuptools build
        pip install --upgrade pip
        
        # æž„å»ºwheelåŒ…
        echo "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†wheelæ–‡ä»¶
        if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
          echo "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        fi
        
        # é‡å‘½åä¸ºLinuxå¹³å°æ ¼å¼
        for whl in dist/*.whl; do
          filename=$(basename "$whl")
          # æ ¹æ®Pythonç‰ˆæœ¬ç”Ÿæˆæ­£ç¡®çš„å¹³å°æ ‡ç­¾
          if [ "${{ matrix.python-version }}" = "3.10" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp310-cp310-manylinux_2_31_x86_64-/")
          elif [ "${{ matrix.python-version }}" = "3.11" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp311-cp311-manylinux_2_31_x86_64-/")
          elif [ "${{ matrix.python-version }}" = "3.12" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp312-cp312-manylinux_2_31_x86_64-/")
          fi
          if [ "$filename" != "$newname" ]; then
            mv "dist/$filename" "dist/$newname"
            echo "é‡å‘½å: $filename -> $newname"
          fi
        done
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p ../output/linux/${{ matrix.python-version }}
        cp dist/*.whl ../output/linux/${{ matrix.python-version }}/
        
        echo "âœ… Linux Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        ls -lh dist/
    
    - name: Upload Linux wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-wheel-${{ matrix.python-version }}
        path: output/linux/${{ matrix.python-version }}/
        retention-days: 7

  linux-build-311:
    name: Linux Build (Python 3.11)
    runs-on: ubuntu-latest
    needs: linux-build-310
    strategy:
      matrix:
        python-version: ["3.11"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
    
    - name: Build Linux wheel (Python ${{ matrix.python-version }})
      run: |
        set -e
        echo "========== å¼€å§‹æž„å»º Linux Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        python -m venv /tmp/alg-build-linux-${{ matrix.python-version }}-venv
        source /tmp/alg-build-linux-${{ matrix.python-version }}-venv/bin/activate
        
        rm -rf build dist *.egg-info 2>/dev/null || true
        pip install wheel setuptools build 
        pip install --upgrade pip
        
        echo "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
          echo "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        fi
        
        for whl in dist/*.whl; do
          filename=$(basename "$whl")
          if [ "${{ matrix.python-version }}" = "3.11" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp311-cp311-manylinux_2_31_x86_64-/")
          fi
          if [ "$filename" != "$newname" ]; then
            mv "dist/$filename" "dist/$newname"
            echo "é‡å‘½å: $filename -> $newname"
          fi
        done
        
        mkdir -p ../output/linux/${{ matrix.python-version }}
        cp dist/*.whl ../output/linux/${{ matrix.python-version }}/
        
        echo "âœ… Linux Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        ls -lh dist/
    
    - name: Upload Linux wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-wheel-${{ matrix.python-version }}
        path: output/linux/${{ matrix.python-version }}/
        retention-days: 7

  linux-build-312:
    name: Linux Build (Python 3.12)
    runs-on: ubuntu-latest
    needs: linux-build-311
    strategy:
      matrix:
        python-version: ["3.12"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
    
    - name: Build Linux wheel (Python ${{ matrix.python-version }})
      run: |
        set -e
        echo "========== å¼€å§‹æž„å»º Linux Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        python -m venv /tmp/alg-build-linux-${{ matrix.python-version }}-venv
        source /tmp/alg-build-linux-${{ matrix.python-version }}-venv/bin/activate
        
        rm -rf build dist *.egg-info 2>/dev/null || true
        pip install wheel setuptools build
        pip install --upgrade pip
        
        echo "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
          echo "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        fi
        
        for whl in dist/*.whl; do
          filename=$(basename "$whl")
          if [ "${{ matrix.python-version }}" = "3.12" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp312-cp312-manylinux_2_31_x86_64-/")
          fi
          if [ "$filename" != "$newname" ]; then
            mv "dist/$filename" "dist/$newname"
            echo "é‡å‘½å: $filename -> $newname"
          fi
        done
        
        mkdir -p ../output/linux/${{ matrix.python-version }}
        cp dist/*.whl ../output/linux/${{ matrix.python-version }}/
        
        echo "âœ… Linux Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        ls -lh dist/
    
    - name: Upload Linux wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-wheel-${{ matrix.python-version }}
        path: output/linux/${{ matrix.python-version }}/
        retention-days: 7

  # 2. Windows å¹³å°æž„å»º
  windows-build-310:
    name: Windows Build (Python 3.10)
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Build Windows wheel (Python ${{ matrix.python-version }})
      shell: pwsh
      run: |
        Write-Host "========== å¼€å§‹æž„å»º Windows Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        
        # åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
        python -m venv C:\alg-build-windows-${{ matrix.python-version }}-venv
        C:\alg-build-windows-${{ matrix.python-version }}-venv\Scripts\Activate.ps1
        
        # æ¸…ç†æ—§æž„å»º
        Remove-Item -Recurse -Force build, dist, *.egg-info -ErrorAction SilentlyContinue
        
        # å®‰è£…æž„å»ºå·¥å…·
        pip install wheel setuptools build
        pip install --upgrade pip
        
        # æž„å»ºwheelåŒ…
        Write-Host "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†wheelæ–‡ä»¶
        if (-not (Test-Path "dist") -or -not (Get-ChildItem "dist\*.whl" -ErrorAction SilentlyContinue)) {
          Write-Host "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        }
        
        # é‡å‘½åä¸ºWindowså¹³å°æ ¼å¼
        Get-ChildItem "dist\*.whl" | ForEach-Object {
          $filename = $_.Name
          if (${{ matrix.python-version }} -eq "3.10") {
            $newname = $filename -replace "-any-", "-cp310-cp310-win_amd64-"
          } elseif (${{ matrix.python-version }} -eq "3.11") {
            $newname = $filename -replace "-any-", "-cp311-cp311-win_amd64-"
          } elseif (${{ matrix.python-version }} -eq "3.12") {
            $newname = $filename -replace "-any-", "-cp312-cp312-win_amd64-"
          }
          if ($filename -ne $newname) {
            Rename-Item -Path "dist\$filename" -NewName $newname
            Write-Host "é‡å‘½å: $filename -> $newname"
          }
        }
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Force -Path "..\output\windows\${{ matrix.python-version }}" | Out-Null
        Copy-Item "dist\*.whl" -Destination "..\output\windows\${{ matrix.python-version }}\"
        
        Write-Host "âœ… Windows Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        Get-ChildItem dist\
    
    - name: Upload Windows wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-wheel-${{ matrix.python-version }}
        path: output/windows/${{ matrix.python-version }}/
        retention-days: 7

  windows-build-311:
    name: Windows Build (Python 3.11)
    runs-on: windows-latest
    needs: windows-build-310
    strategy:
      matrix:
        python-version: ["3.11"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Build Windows wheel (Python ${{ matrix.python-version }})
      shell: pwsh
      run: |
        Write-Host "========== å¼€å§‹æž„å»º Windows Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        python -m venv C:\alg-build-windows-${{ matrix.python-version }}-venv
        C:\alg-build-windows-${{ matrix.python-version }}-venv\Scripts\Activate.ps1
        
        Remove-Item -Recurse -Force build, dist, *.egg-info -ErrorAction SilentlyContinue
        pip install wheel setuptools build
        pip install --upgrade pip
        
        Write-Host "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        if (-not (Test-Path "dist") -or -not (Get-ChildItem "dist\*.whl" -ErrorAction SilentlyContinue)) {
          Write-Host "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        }
        
        Get-ChildItem "dist\*.whl" | ForEach-Object {
          $filename = $_.Name
          if (${{ matrix.python-version }} -eq "3.11") {
            $newname = $filename -replace "-any-", "-cp311-cp311-win_amd64-"
          }
          if ($filename -ne $newname) {
            Rename-Item -Path "dist\$filename" -NewName $newname
            Write-Host "é‡å‘½å: $filename -> $newname"
          }
        }
        
        New-Item -ItemType Directory -Force -Path "..\output\windows\${{ matrix.python-version }}" | Out-Null
        Copy-Item "dist\*.whl" -Destination "..\output\windows\${{ matrix.python-version }}\"
        
        Write-Host "âœ… Windows Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        Get-ChildItem dist\
    
    - name: Upload Windows wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-wheel-${{ matrix.python-version }}
        path: output/windows/${{ matrix.python-version }}/
        retention-days: 7

  windows-build-312:
    name: Windows Build (Python 3.12)
    runs-on: windows-latest
    needs: windows-build-311
    strategy:
      matrix:
        python-version: ["3.12"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Build Windows wheel (Python ${{ matrix.python-version }})
      shell: pwsh
      run: |
        Write-Host "========== å¼€å§‹æž„å»º Windows Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        python -m venv C:\alg-build-windows-${{ matrix.python-version }}-venv
        C:\alg-build-windows-${{ matrix.python-version }}-venv\Scripts\Activate.ps1
        
        Remove-Item -Recurse -Force build, dist, *.egg-info -ErrorAction SilentlyContinue
        pip install wheel setuptools build
        pip install --upgrade pip
        
        Write-Host "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        if (-not (Test-Path "dist") -or -not (Get-ChildItem "dist\*.whl" -ErrorAction SilentlyContinue)) {
          Write-Host "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        }
        
        Get-ChildItem "dist\*.whl" | ForEach-Object {
          $filename = $_.Name
          if (${{ matrix.python-version }} -eq "3.12") {
            $newname = $filename -replace "-any-", "-cp312-cp312-win_amd64-"
          }
          if ($filename -ne $newname) {
            Rename-Item -Path "dist\$filename" -NewName $newname
            Write-Host "é‡å‘½å: $filename -> $newname"
          }
        }
        
        New-Item -ItemType Directory -Force -Path "..\output\windows\${{ matrix.python-version }}" | Out-Null
        Copy-Item "dist\*.whl" -Destination "..\output\windows\${{ matrix.python-version }}\"
        
        Write-Host "âœ… Windows Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        Get-ChildItem dist\
    
    - name: Upload Windows wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-wheel-${{ matrix.python-version }}
        path: output/windows/${{ matrix.python-version }}/
        retention-days: 7

  # 3. macOS å¹³å°æž„å»º
  macos-build-310:
    name: macOS Build (Python 3.10)
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Build macOS wheel (Python ${{ matrix.python-version }})
      run: |
        set -e
        echo "========== å¼€å§‹æž„å»º macOS Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        
        # åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
        python -m venv /tmp/alg-build-macos-${{ matrix.python-version }}-venv
        source /tmp/alg-build-macos-${{ matrix.python-version }}-venv/bin/activate
        
        # æ¸…ç†æ—§æž„å»º
        rm -rf build dist *.egg-info 2>/dev/null || true
        
        # å®‰è£…æž„å»ºå·¥å…·
        pip install wheel setuptools build
        pip install --upgrade pip
        
        # æž„å»ºwheelåŒ…
        echo "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†wheelæ–‡ä»¶
        if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
          echo "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        fi
        
        # é‡å‘½åä¸ºmacOSå¹³å°æ ¼å¼
        for whl in dist/*.whl; do
          filename=$(basename "$whl")
          # æ ¹æ®Pythonç‰ˆæœ¬å’Œæž¶æž„ç”Ÿæˆæ­£ç¡®çš„å¹³å°æ ‡ç­¾
          if [ "${{ matrix.python-version }}" = "3.10" ]; then
            # macOS æœ‰ä¸åŒçš„æž¶æž„ï¼Œè¿™é‡Œå‡è®¾æž„å»ºé€šç”¨æž¶æž„
            newname=$(echo "$filename" | sed "s/-any-/-cp310-cp310-macosx_10_15_x86_64-/")
          elif [ "${{ matrix.python-version }}" = "3.11" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp311-cp311-macosx_10_15_x86_64-/")
          elif [ "${{ matrix.python-version }}" = "3.12" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp312-cp312-macosx_10_15_x86_64-/")
          fi
          if [ "$filename" != "$newname" ]; then
            mv "dist/$filename" "dist/$newname"
            echo "é‡å‘½å: $filename -> $newname"
          fi
        done
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p ../output/macos/${{ matrix.python-version }}
        cp dist/*.whl ../output/macos/${{ matrix.python-version }}/
        
        echo "âœ… macOS Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        ls -lh dist/
    
    - name: Upload macOS wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-wheel-${{ matrix.python-version }}
        path: output/macos/${{ matrix.python-version }}/
        retention-days: 7

  macos-build-311:
    name: macOS Build (Python 3.11)
    runs-on: macos-latest
    needs: macos-build-310
    strategy:
      matrix:
        python-version: ["3.11"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Build macOS wheel (Python ${{ matrix.python-version }})
      run: |
        set -e
        echo "========== å¼€å§‹æž„å»º macOS Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        python -m venv /tmp/alg-build-macos-${{ matrix.python-version }}-venv
        source /tmp/alg-build-macos-${{ matrix.python-version }}-venv/bin/activate
        
        rm -rf build dist *.egg-info 2>/dev/null || true
        pip install wheel setuptools build
        pip install --upgrade pip
        
        echo "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
          echo "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        fi
        
        for whl in dist/*.whl; do
          filename=$(basename "$whl")
          if [ "${{ matrix.python-version }}" = "3.11" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp311-cp311-macosx_10_15_x86_64-/")
          fi
          if [ "$filename" != "$newname" ]; then
            mv "dist/$filename" "dist/$newname"
            echo "é‡å‘½å: $filename -> $newname"
          fi
        done
        
        mkdir -p ../output/macos/${{ matrix.python-version }}
        cp dist/*.whl ../output/macos/${{ matrix.python-version }}/
        
        echo "âœ… macOS Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        ls -lh dist/
    
    - name: Upload macOS wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-wheel-${{ matrix.python-version }}
        path: output/macos/${{ matrix.python-version }}/
        retention-days: 7

  macos-build-312:
    name: macOS Build (Python 3.12)
    runs-on: macos-latest
    needs: macos-build-311
    strategy:
      matrix:
        python-version: ["3.12"]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Build macOS wheel (Python ${{ matrix.python-version }})
      run: |
        set -e
        echo "========== å¼€å§‹æž„å»º macOS Python ${{ matrix.python-version }} åŒ… =========="
        
        cd pyqpanda-algorithm
        python -m venv /tmp/alg-build-macos-${{ matrix.python-version }}-venv
        source /tmp/alg-build-macos-${{ matrix.python-version }}-venv/bin/activate
        
        rm -rf build dist *.egg-info 2>/dev/null || true
        pip install wheel setuptools build
        pip install --upgrade pip
        
        echo "å¼€å§‹æž„å»ºwheelåŒ…..."
        python setup.py bdist_wheel
        
        if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
          echo "âš ï¸ å°è¯•ä½¿ç”¨buildå·¥å…·æž„å»º..."
          python -m build --wheel
        fi
        
        for whl in dist/*.whl; do
          filename=$(basename "$whl")
          if [ "${{ matrix.python-version }}" = "3.12" ]; then
            newname=$(echo "$filename" | sed "s/-any-/-cp312-cp312-macosx_10_15_x86_64-/")
          fi
          if [ "$filename" != "$newname" ]; then
            mv "dist/$filename" "dist/$newname"
            echo "é‡å‘½å: $filename -> $newname"
          fi
        done
        
        mkdir -p ../output/macos/${{ matrix.python-version }}
        cp dist/*.whl ../output/macos/${{ matrix.python-version }}/
        
        echo "âœ… macOS Python ${{ matrix.python-version }} æž„å»ºå®Œæˆ"
        ls -lh dist/
    
    - name: Upload macOS wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-wheel-${{ matrix.python-version }}
        path: output/macos/${{ matrix.python-version }}/
        retention-days: 7

  # 4. æ–‡æ¡£æž„å»º
  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest
    needs: [linux-build-312, windows-build-312, macos-build-312]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Build Documentation
      run: |
        set -e
        echo "========== å¼€å§‹æž„å»ºé¡¹ç›®æ–‡æ¡£ =========="
        
        # æ£€æŸ¥ç›®å½•ç»“æž„
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        
        # åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
        python -m venv /tmp/alg-build-docs-venv
        source /tmp/alg-build-docs-venv/bin/activate
        
        # æ£€æŸ¥ Tutorials/source ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "Tutorials/source" ]; then
          echo "âŒ é”™è¯¯: Tutorials/source ç›®å½•ä¸å­˜åœ¨"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo "Tutorials ç›®å½•å†…å®¹:"
          ls -la Tutorials/ 2>/dev/null || echo "Tutorials ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # å®‰è£…æ–‡æ¡£æž„å»ºä¾èµ–
        echo "å®‰è£…æ–‡æ¡£æž„å»ºå·¥å…·..."
        pip install sphinx sphinx_autoapi sphinx-material beautifulsoup4
        
        # è¿›å…¥æ–‡æ¡£æºç›®å½•
        cd Tutorials/source
        
        echo "å½“å‰æ–‡æ¡£æºç›®å½•: $(pwd)"
        echo "æ–‡æ¡£æºç›®å½•å†…å®¹:"
        ls -la
        
        # æ¸…ç†æ—§çš„æž„å»ºè¾“å‡º
        rm -rf build 2>/dev/null || true
        
        # æž„å»ºHTMLæ–‡æ¡£
        echo "æ­£åœ¨æž„å»ºHTMLæ–‡æ¡£..."
        sphinx-build -b html ./ ./build/
        
        # å›žåˆ°æ ¹ç›®å½•
        cd ../..
        
        # åˆ›å»ºæ–‡æ¡£è¾“å‡ºç›®å½•
        mkdir -p output/docs/html
        
        # å¤åˆ¶ç”Ÿæˆçš„æ–‡æ¡£
        echo "å¤åˆ¶ç”Ÿæˆçš„æ–‡æ¡£..."
        cp -r Tutorials/source/build/* output/docs/html/
        
        echo "âœ… æ–‡æ¡£æž„å»ºå®Œæˆ"
        echo "ç”Ÿæˆçš„æ–‡æ¡£æ–‡ä»¶:"
        find output/docs/html -name "*.html" | wc -l
        echo "ä¸»æ–‡æ¡£æ–‡ä»¶: output/docs/html/index.html"
        
        # åˆ›å»ºæ–‡æ¡£ç´¢å¼•æ–‡ä»¶
        cat > output/docs/README.md << EOF
        # PyQPanda Algorithm é¡¹ç›®æ–‡æ¡£
        
        ## æ–‡æ¡£è¯´æ˜Ž
        æœ¬æ–‡æ¡£ä½¿ç”¨ Sphinx + AutoAPI è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å«äº†é¡¹ç›®çš„å®Œæ•´ API æ–‡æ¡£ã€‚
        
        ## æŸ¥çœ‹æ–‡æ¡£
        1. æ‰“å¼€ \`html/index.html\` æ–‡ä»¶åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹
        2. æ”¯æŒæœç´¢åŠŸèƒ½
        
        ## æž„å»ºä¿¡æ¯
        - æž„å»ºæ—¶é—´: $(date)
        - æž„å»ºå·¥å…·: Sphinx $(sphinx-build --version 2>&1 | head -1)
        - æ–‡æ¡£é¡µæ•°: $(find output/docs/html -name "*.html" | wc -l) ä¸ªHTMLæ–‡ä»¶
        
        ## åŒ…å«çš„æ¨¡å—æ–‡æ¡£
        - pyqpanda_alg.Grover - Groveræœç´¢ç®—æ³•
        - pyqpanda_alg.QAE - é‡å­å¹…åº¦ä¼°è®¡
        - pyqpanda_alg.QAOA - é‡å­è¿‘ä¼¼ä¼˜åŒ–ç®—æ³•
        - pyqpanda_alg.QARM - é‡å­å…³è”è§„åˆ™æŒ–æŽ˜
        - pyqpanda_alg.QCmp - é‡å­æ¯”è¾ƒå™¨
        - pyqpanda_alg.QPCA - é‡å­ä¸»æˆåˆ†åˆ†æž
        - pyqpanda_alg.QSVD - é‡å­å¥‡å¼‚å€¼åˆ†è§£
        - pyqpanda_alg.QSVM - é‡å­æ”¯æŒå‘é‡æœº
        - pyqpanda_alg.QSVR - é‡å­æ”¯æŒå‘é‡å›žå½’
        - pyqpanda_alg.QUBO - é‡å­æ— çº¦æŸäºŒè¿›åˆ¶ä¼˜åŒ–
        - pyqpanda_alg.QmRMR - é‡å­æœ€å°å†—ä½™æœ€å¤§ç›¸å…³æ€§
        - pyqpanda_alg.QKmeans - é‡å­K-meansèšç±»
        - pyqpanda_alg.QSEncode - é‡å­çŠ¶æ€ç¼–ç 
        - pyqpanda_alg.plugin - æ’ä»¶ç³»ç»Ÿ
        
        ## é‡æ–°æž„å»º
        å¦‚éœ€é‡æ–°æž„å»ºæ–‡æ¡£ï¼Œè¯·è¿è¡Œ:
        \`\`\`bash
        cd Tutorials/source
        sphinx-build -b html ./ ./build/
        \`\`\`
        EOF
        
        echo "âœ… æ–‡æ¡£æ‰“åŒ…å®Œæˆ"
        echo "è¾“å‡ºç›®å½•ç»“æž„:"
        ls -lh output/docs/
        echo ""
        echo "HTMLæ–‡æ¡£ç¤ºä¾‹:"
        ls -lh output/docs/html/*.html | head -5
    
    - name: Upload Documentation Artifact
      uses: actions/upload-artifact@v4
      with:
        name: documentation-html
        path: output/docs/
        retention-days: 7

  # 5. è‡ªåŠ¨åŒ–æµ‹è¯•
  automated-testing:
    name: Automated Testing
    runs-on: ubuntu-latest
    needs: [linux-build-312]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    
    - name: Download Linux wheel artifact
      uses: actions/download-artifact@v4
      with:
        name: linux-wheel-3.10
        path: downloaded-wheels/
    
    - name: Run Automated Tests
      run: |
        set -e
        echo "å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•"
        
        # åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
        python -m venv /tmp/alg-test-venv
        source /tmp/alg-test-venv/bin/activate
        
        # æŸ¥æ‰¾wheelåŒ…
        WHEEL_FILE=$(find downloaded-wheels -name "*.whl" | head -1)
        
        if [ -n "$WHEEL_FILE" ]; then
          echo "å®‰è£…wheelåŒ…: $WHEEL_FILE"
          pip install "$WHEEL_FILE"
        else
          if [ -f "pyqpanda-algorithm/setup.py" ]; then
            cd pyqpanda-algorithm
            pip install -e .
            cd ..
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°wheelåŒ…ä¸”æ²¡æœ‰setup.py"
            exit 1
          fi
        fi
        
        # å®‰è£…é¡¹ç›®ä¾èµ–
        pip install numpy scipy sympy pandas
        
        if [ -f "pyqpanda-algorithm/requirements.txt" ]; then
          pip install -r pyqpanda-algorithm/requirements.txt
        fi
        
        # å®‰è£…æµ‹è¯•ä¾èµ–
        pip install pytest allure-pytest pytest-html pytest-rerunfailures pytest-xdist
        
        # æ£€æŸ¥æµ‹è¯•ç›®å½•
        if [ ! -d "test" ]; then
          echo "âŒ é”™è¯¯: test ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è¿›å…¥æµ‹è¯•ç›®å½•
        cd test
        
        # åˆ›å»ºæµ‹è¯•è¾“å‡ºç›®å½•
        mkdir -p ../output/test_results
        mkdir -p ../output/test_results/allure-results
        mkdir -p ../output/test_results/html-report
        
        # è¿è¡Œæµ‹è¯•
        echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
        pytest -v \
          --junitxml=../output/test_results/junit-results.xml \
          --alluredir=../output/test_results/allure-results \
          --clean-alluredir \
          --tb=short \
          --disable-warnings \
          --maxfail=5 \
          || true
        
        # ç”ŸæˆHTMLæŠ¥å‘Š
        echo "ç”ŸæˆHTMLæŠ¥å‘Š..."
        pytest -v \
          --html=../output/test_results/html-report/report.html \
          --self-contained-html \
          --tb=short \
          --disable-warnings \
          --maxfail=5 \
          || true
        
        # ç”ŸæˆAllureæŠ¥å‘Š
        if [ -d "../output/test_results/allure-results" ] && [ -n "$(ls -A ../output/test_results/allure-results 2>/dev/null)" ]; then
          echo "å®‰è£…AllureæŠ¥å‘Šå·¥å…·..."
          curl -o allure-2.17.3.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.17.3/allure-2.17.3.tgz
          tar -zxvf allure-2.17.3.tgz
          
          echo "ç”ŸæˆAllureæŠ¥å‘Š..."
          ./allure-2.17.3/bin/allure generate ../output/test_results/allure-results -o ../output/test_results/allure-report --clean
        fi
        
        cd ..
        echo "âœ… è‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆ"
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: output/test_results/
        retention-days: 7

  # 6. æ‰“åŒ…æ‰€æœ‰äº§ç‰©
  package-all:
    name: Package All Artifacts
    runs-on: ubuntu-latest
    needs: [docs-build, automated-testing]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    
    - name: Download all artifacts
      run: |
        mkdir -p all-artifacts
        mkdir -p all-artifacts/wheels
        mkdir -p all-artifacts/docs
        mkdir -p all-artifacts/tests
    
    - name: Download Linux wheels
      uses: actions/download-artifact@v4
      with:
        name: linux-wheel-3.10
        path: all-artifacts/wheels/
    
    - name: Download Windows wheels
      uses: actions/download-artifact@v4
      with:
        name: windows-wheel-3.10
        path: all-artifacts/wheels/
    
    - name: Download macOS wheels
      uses: actions/download-artifact@v4
      with:
        name: macos-wheel-3.10
        path: all-artifacts/wheels/
    
    - name: Download Documentation
      uses: actions/download-artifact@v4
      with:
        name: documentation-html
        path: all-artifacts/docs/
    
    - name: Download Test Results
      uses: actions/download-artifact@v4
      with:
        name: test-results
        path: all-artifacts/tests/
    
    - name: Create Release Package
      run: |
        echo "========== æ‰“åŒ…æ‰€æœ‰æž„å»ºäº§ç‰© =========="
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release_package/wheels
        mkdir -p release_package/docs
        mkdir -p release_package/test_reports
        
        # å¤åˆ¶æ‰€æœ‰wheelæ–‡ä»¶
        echo "æ”¶é›†æ‰€æœ‰å¹³å°çš„wheelæ–‡ä»¶..."
        find all-artifacts/wheels -name "*.whl" -type f -exec cp {} release_package/wheels/ \;
        
        # å¤åˆ¶æ–‡æ¡£
        if [ -d "all-artifacts/docs" ]; then
          cp -r all-artifacts/docs/* release_package/docs/
        fi
        
        # å¤åˆ¶æµ‹è¯•ç»“æžœ
        if [ -d "all-artifacts/tests" ]; then
          cp -r all-artifacts/tests/* release_package/test_reports/
        fi
        
        # åˆ›å»ºREADMEæ–‡ä»¶
        cat > release_package/README.md << EOF
        # PyQPanda Algorithm å¤šå¹³å°å¤šç‰ˆæœ¬å‘å¸ƒåŒ…
        
        ## æ”¯æŒçš„å¹³å°å’ŒPythonç‰ˆæœ¬
        
        | å¹³å° | Pythonç‰ˆæœ¬ | æž¶æž„ | å¤‡æ³¨ |
        |------|------------|------|------|
        | Linux | 3.10, 3.11, 3.12 | x86_64 | åœ¨UbuntuçŽ¯å¢ƒä¸­æž„å»º |
        | Windows | 3.10, 3.11, 3.12 | AMD64 | åœ¨WindowsçŽ¯å¢ƒä¸­æž„å»º |
        | macOS | 3.10, 3.11, 3.12 | x86_64 | åœ¨macOSçŽ¯å¢ƒä¸­æž„å»º |
        
        ## åŒ…å«å†…å®¹
        1. **WheelåŒ…** (\`wheels/\` ç›®å½•)
           - æ‰€æœ‰å¹³å°çš„é¢„ç¼–è¯‘åŒ…
           - æŒ‰å¹³å°å’ŒPythonç‰ˆæœ¬åˆ†ç±»
        
        2. **é¡¹ç›®æ–‡æ¡£** (\`docs/\` ç›®å½•)
           - å®Œæ•´çš„APIæ–‡æ¡£
           - HTMLæ ¼å¼ï¼Œå¯ç›´æŽ¥åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹
           - æ‰“å¼€ \`docs/html/index.html\` å¼€å§‹æµè§ˆ
        
        3. **æµ‹è¯•æŠ¥å‘Š** (\`test_reports/\` ç›®å½•)
           - è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æžœ
           - JUnitæ ¼å¼æŠ¥å‘Š
           - HTMLå¯è§†åŒ–æŠ¥å‘Š
           - Allureé«˜çº§æŠ¥å‘Š
        
        ## æ–‡ä»¶å‘½åè§„èŒƒ
        - Linux: \`åŒ…å-ç‰ˆæœ¬-cp{ç‰ˆæœ¬å·}-cp{ç‰ˆæœ¬å·}-manylinux_2_31_x86_64.whl\`
        - Windows: \`åŒ…å-ç‰ˆæœ¬-cp{ç‰ˆæœ¬å·}-cp{ç‰ˆæœ¬å·}-win_amd64.whl\`
        - macOS: \`åŒ…å-ç‰ˆæœ¬-cp{ç‰ˆæœ¬å·}-cp{ç‰ˆæœ¬å·}-macosx_10_15_x86_64.whl\`
        
        ## ä½¿ç”¨è¯´æ˜Ž
        \`\`\`bash
        # æ ¹æ®æ‚¨çš„å¹³å°å’ŒPythonç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„æ–‡ä»¶
        pip install wheels/your_package-*.whl
        
        # æŸ¥çœ‹æ–‡æ¡£
        # æ‰“å¼€ docs/html/index.html åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹
        
        # æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
        # æ‰“å¼€ test_reports/html-report/report.html æŸ¥çœ‹æµ‹è¯•ç»“æžœ
        \`\`\`
        
        ## æž„å»ºçŽ¯å¢ƒ
        - æž„å»ºç³»ç»Ÿ: GitHub Actions
        - æž„å»ºæ—¶é—´: $(date)
        - æ€»åŒ…æ•°é‡: \$(ls -1 release_package/wheels/*.whl 2>/dev/null | wc -l 2>/dev/null || echo "0")
        EOF
        
        # åˆ›å»ºç›®å½•ç»“æž„è¯´æ˜Ž
        cat > release_package/DIRECTORY_STRUCTURE.md << EOF
        # ç›®å½•ç»“æž„
        
        release_package/
        â”œâ”€â”€ README.md              # æœ¬æ–‡ä»¶
        â”œâ”€â”€ DIRECTORY_STRUCTURE.md # ç›®å½•ç»“æž„è¯´æ˜Ž
        â”œâ”€â”€ wheels/                # æ‰€æœ‰å¹³å°çš„WheelåŒ…
        â”‚   â”œâ”€â”€ linux_3.10_*.whl
        â”‚   â”œâ”€â”€ linux_3.11_*.whl
        â”‚   â”œâ”€â”€ linux_3.12_*.whl
        â”‚   â”œâ”€â”€ windows_3.10_*.whl
        â”‚   â”œâ”€â”€ windows_3.11_*.whl
        â”‚   â”œâ”€â”€ windows_3.12_*.whl
        â”‚   â”œâ”€â”€ macos_3.10_*.whl
        â”‚   â”œâ”€â”€ macos_3.11_*.whl
        â”‚   â””â”€â”€ macos_3.12_*.whl
        â”œâ”€â”€ docs/                  # é¡¹ç›®æ–‡æ¡£
        â”‚   â”œâ”€â”€ README.md          # æ–‡æ¡£è¯´æ˜Ž
        â”‚   â””â”€â”€ html/              # HTMLæ–‡æ¡£
        â”‚       â”œâ”€â”€ index.html     # æ–‡æ¡£é¦–é¡µ
        â”‚       â”œâ”€â”€ *.html         # å…¶ä»–é¡µé¢
        â”‚       â””â”€â”€ _static/       # é™æ€èµ„æº
        â””â”€â”€ test_reports/          # æµ‹è¯•æŠ¥å‘Š
            â”œâ”€â”€ junit-results.xml  # JUnitæ ¼å¼æµ‹è¯•ç»“æžœ
            â”œâ”€â”€ html-report/       # HTMLæµ‹è¯•æŠ¥å‘Š
            â”‚   â””â”€â”€ report.html    # HTMLæµ‹è¯•æŠ¥å‘Š
            â”œâ”€â”€ allure-results/    # AllureåŽŸå§‹æ•°æ®
            â””â”€â”€ allure-report/     # Allureæµ‹è¯•æŠ¥å‘Š(å¦‚ç”Ÿæˆ)
        EOF
        
        echo "âœ… æ‰“åŒ…å®Œæˆ"
        echo "å‘å¸ƒåŒ…å†…å®¹:"
        find release_package -type f | sort
    
    - name: Upload Final Package
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: release_package/
        retention-days: 30
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release_package/**/*.whl
          release_package/docs/html/index.html
        body_path: release_package/README.md

  # 7. å·¥ä½œæµçŠ¶æ€æ±‡æ€»
  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [package-all]
    if: always()
    
    steps:
    - name: Check workflow status
      run: |
        echo "ðŸŽ‰ PyQPanda Algorithm CI/CD Pipeline æ‰§è¡Œå®Œæˆ!"
        echo ""
        echo "ðŸ“¦ æž„å»ºäº§ç‰©:"
        echo "  - Linux wheels (Python 3.10, 3.11, 3.12)"
        echo "  - Windows wheels (Python 3.10, 3.11, 3.12)"
        echo "  - macOS wheels (Python 3.10, 3.11, 3.12)"
        echo "  - HTML Documentation"
        echo "  - Automated Test Reports"
        echo ""
        echo "ðŸ“‚ æ‰€æœ‰äº§ç‰©å·²æ‰“åŒ…è‡³ 'release-package' å·¥ä»¶"
        echo "ðŸ“„ è¯¦ç»†æŠ¥å‘Šå¯åœ¨ GitHub Actions é¡µé¢æŸ¥çœ‹"
