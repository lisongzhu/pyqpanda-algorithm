version: '1.0'
name: pipeline-cicd
displayName: pipeline-cicd
triggers:
  trigger: auto
  push:
    branches:
      include:
        - main
        - master
        - develop
stages:
  - name: linux_build_310
    displayName: Linux平台构建 (Python 3.10)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_linux_package_310
        displayName: 构建Linux包 (Python 3.10)
        pythonVersion: '3.10'
        commands:
          - |
            set -e
            echo "========== 开始构建 Linux Python 3.10 包 =========="

            # 创建虚拟环境
            python3 -m venv /tmp/alg-build-linux-310-venv
            source /tmp/alg-build-linux-310-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为Linux平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp310-cp310-manylinux2014_x86_64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/linux/3.10
            pip install dist/*.whl
            cp dist/*.whl ../output/linux/3.10/

            echo "✅ Linux Python 3.10 构建完成"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: linux_wheel_310
            path:
              - output/linux/3.10/
  - name: linux_build_311
    displayName: Linux平台构建 (Python 3.11)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_linux_package_311
        displayName: 构建Linux包 (Python 3.11)
        pythonVersion: '3.11'
        commands:
          - |
            set -e
            echo "========== 开始构建 Linux Python 3.11 包 =========="

            # 创建虚拟环境
            python3.11 -m venv /tmp/alg-build-linux-311-venv
            source /tmp/alg-build-linux-311-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为Linux平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp311-cp311-manylinux2014_x86_64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/linux/3.11
            cp dist/*.whl ../output/linux/3.11/

            echo "✅ Linux Python 3.11 构建完成"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: linux_wheel_311
            path:
              - output/linux/3.11/
  - name: linux_build_312
    displayName: Linux平台构建 (Python 3.12)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_linux_package_312
        displayName: 构建Linux包 (Python 3.12)
        pythonVersion: '3.12'
        commands:
          - |
            set -e
            echo "========== 开始构建 Linux Python 3.12 包 =========="

            # 创建虚拟环境
            python3.12 -m venv /tmp/alg-build-linux-312-venv
            source /tmp/alg-build-linux-312-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为Linux平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp312-cp312-manylinux2014_x86_64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/linux/3.12
            cp dist/*.whl ../output/linux/3.12/

            echo "✅ Linux Python 3.12 构建完成"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: linux_wheel_312
            path:
              - output/linux/3.12/
  - name: windows_build_310
    displayName: Windows平台构建 (Python 3.10)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_windows_package_310
        displayName: 构建Windows包 (Python 3.10)
        pythonVersion: '3.10'
        commands:
          - |
            set -e
            echo "========== 在CentOS中构建Windows格式 Python 3.10 包 =========="

            # 创建虚拟环境
            python3 -m venv /tmp/alg-build-windows-310-venv
            source /tmp/alg-build-windows-310-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为Windows平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp310-cp310-win_amd64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/windows/3.10
            cp dist/*.whl ../output/windows/3.10/

            echo "✅ Windows Python 3.10 格式包构建完成"
            echo "注意：这是在CentOS环境中构建的纯Python包，仅重命名了平台标签"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: windows_wheel_310
            path:
              - output/windows/3.10/
  - name: windows_build_311
    displayName: Windows平台构建 (Python 3.11)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_windows_package_311
        displayName: 构建Windows包 (Python 3.11)
        pythonVersion: '3.11'
        commands:
          - |
            set -e
            echo "========== 在CentOS中构建Windows格式 Python 3.11 包 =========="

            # 创建虚拟环境
            python3.11 -m venv /tmp/alg-build-windows-311-venv
            source /tmp/alg-build-windows-311-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为Windows平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp311-cp311-win_amd64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/windows/3.11
            cp dist/*.whl ../output/windows/3.11/

            echo "✅ Windows Python 3.11 格式包构建完成"
            echo "注意：这是在CentOS环境中构建的纯Python包，仅重命名了平台标签"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: windows_wheel_311
            path:
              - output/windows/3.11/
  - name: windows_build_312
    displayName: Windows平台构建 (Python 3.12)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_windows_package_312
        displayName: 构建Windows包 (Python 3.12)
        pythonVersion: '3.12'
        commands:
          - |
            set -e
            echo "========== 在CentOS中构建Windows格式 Python 3.12 包 =========="

            # 创建虚拟环境
            python3.12 -m venv /tmp/alg-build-windows-312-venv
            source /tmp/alg-build-windows-312-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为Windows平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp312-cp312-win_amd64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/windows/3.12
            cp dist/*.whl ../output/windows/3.12/

            echo "✅ Windows Python 3.12 格式包构建完成"
            echo "注意：这是在CentOS环境中构建的纯Python包，仅重命名了平台标签"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: windows_wheel_312
            path:
              - output/windows/3.12/
  - name: macos_build_310
    displayName: macOS平台构建 (Python 3.10)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_macos_package_310
        displayName: 构建macOS包 (Python 3.10)
        pythonVersion: '3.10'
        commands:
          - |
            set -e
            echo "========== 在CentOS中构建macOS格式 Python 3.10 包 =========="

            # 创建虚拟环境
            python3 -m venv /tmp/alg-build-macos-310-venv
            source /tmp/alg-build-macos-310-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为macOS平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp310-cp310-macosx_11_0_arm64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/macos/3.10
            cp dist/*.whl ../output/macos/3.10/

            echo "✅ macOS Python 3.10 格式包构建完成"
            echo "注意：这是在CentOS环境中构建的macOS格式包，仅重命名了平台标签"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: macos_wheel_310
            path:
              - output/macos/3.10/
  - name: macos_build_311
    displayName: macOS平台构建 (Python 3.11)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_macos_package_311
        displayName: 构建macOS包 (Python 3.11)
        pythonVersion: '3.11'
        commands:
          - |
            set -e
            echo "========== 在CentOS中构建macOS格式 Python 3.11 包 =========="

            # 创建虚拟环境
            python3.11 -m venv /tmp/alg-build-macos-311-venv
            source /tmp/alg-build-macos-311-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为macOS平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp311-cp311-macosx_11_0_arm64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/macos/3.11
            cp dist/*.whl ../output/macos/3.11/

            echo "✅ macOS Python 3.11 格式包构建完成"
            echo "注意：这是在CentOS环境中构建的macOS格式包，仅重命名了平台标签"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: macos_wheel_311
            path:
              - output/macos/3.11/
  - name: macos_build_312
    displayName: macOS平台构建 (Python 3.12)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_macos_package_312
        displayName: 构建macOS包 (Python 3.12)
        pythonVersion: '3.12'
        commands:
          - |
            set -e
            echo "========== 在CentOS中构建macOS格式 Python 3.12 包 =========="

            # 创建虚拟环境
            python3.12 -m venv /tmp/alg-build-macos-312-venv
            source /tmp/alg-build-macos-312-venv/bin/activate

            # 进入项目目录
            cd pyqpanda-algorithm

            # 清理旧构建
            rm -rf build dist *.egg-info 2>/dev/null || true

            # 安装构建工具
            pip install wheel setuptools
            pip install --upgrade pip

            # 构建wheel包
            echo "开始构建wheel包..."
            python setup.py bdist_wheel

            # 检查是否生成了wheel文件
            if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
              echo "⚠️ 尝试使用build工具构建..."
              pip install build
              python -m build --wheel
            fi

            # 重命名为macOS平台格式
            for whl in dist/*.whl; do
              filename=$(basename "$whl")
              newname=$(echo "$filename" | sed "s/-any-/-cp312-cp312-macosx_11_0_arm64-/")
              if [ "$filename" != "$newname" ]; then
                mv "dist/$filename" "dist/$newname"
                echo "重命名: $filename -> $newname"
              fi
            done

            # 创建输出目录
            mkdir -p ../output/macos/3.12
            cp dist/*.whl ../output/macos/3.12/

            echo "✅ macOS Python 3.12 格式包构建完成"
            echo "注意：这是在CentOS环境中构建的macOS格式包，仅重命名了平台标签"
            echo "生成的包:"
            ls -lh dist/
        artifacts:
          - name: macos_wheel_312
            path:
              - output/macos/3.12/
  - name: docs_build
    displayName: 文档编译 (Sphinx HTML)
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: build_documentation
        displayName: 构建HTML文档
        pythonVersion: '3.11'
        commands:
          - |
            set -e
            echo "========== 开始构建项目文档 =========="

            # 检查目录结构
            echo "当前工作目录: $(pwd)"
            echo "目录内容:"
            ls -la

            # 创建虚拟环境
            python3.11 -m venv /tmp/alg-build-docs-venv
            source /tmp/alg-build-docs-venv/bin/activate

            # 检查 Tutorials/source 目录是否存在
            if [ ! -d "Tutorials/source" ]; then
              echo "❌ 错误: Tutorials/source 目录不存在"
              echo "当前目录内容:"
              ls -la
              echo "Tutorials 目录内容:"
              ls -la Tutorials/ 2>/dev/null || echo "Tutorials 目录不存在"
              exit 1
            fi

            # 安装文档构建依赖
            echo "安装文档构建工具..."
            pip install sphinx sphinx_autoapi sphinx-material beautifulsoup4

            # 进入文档源目录
            cd Tutorials/source

            echo "当前文档源目录: $(pwd)"
            echo "文档源目录内容:"
            ls -la

            # 清理旧的构建输出
            rm -rf build 2>/dev/null || true

            # 构建HTML文档
            echo "正在构建HTML文档..."
            sphinx-build -b html ./ ./build/

            # 回到根目录
            cd ../..

            # 创建文档输出目录
            mkdir -p output/docs/html

            # 复制生成的文档
            echo "复制生成的文档..."
            cp -r Tutorials/source/build/* output/docs/html/

            echo "✅ 文档构建完成"
            echo "生成的文档文件:"
            find output/docs/html -name "*.html" | wc -l
            echo "主文档文件: output/docs/html/index.html"

            # 创建文档索引文件
            cat > output/docs/README.md << EOF
            # PyQPanda Algorithm 项目文档

            ## 文档说明
            本文档使用 Sphinx + AutoAPI 自动生成，包含了项目的完整 API 文档。

            ## 查看文档
            1. 打开 \`html/index.html\` 文件在浏览器中查看
            2. 支持搜索功能

            ## 构建信息
            - 构建时间: $(date)
            - 构建工具: Sphinx $(sphinx-build --version 2>&1 | head -1)
            - 文档页数: $(find output/docs/html -name "*.html" | wc -l) 个HTML文件

            ## 包含的模块文档
            - pyqpanda_alg.Grover - Grover搜索算法
            - pyqpanda_alg.QAE - 量子幅度估计
            - pyqpanda_alg.QAOA - 量子近似优化算法
            - pyqpanda_alg.QARM - 量子关联规则挖掘
            - pyqpanda_alg.QCmp - 量子比较器
            - pyqpanda_alg.QPCA - 量子主成分分析
            - pyqpanda_alg.QSVD - 量子奇异值分解
            - pyqpanda_alg.QSVM - 量子支持向量机
            - pyqpanda_alg.QSVR - 量子支持向量回归
            - pyqpanda_alg.QUBO - 量子无约束二进制优化
            - pyqpanda_alg.QmRMR - 量子最小冗余最大相关性
            - pyqpanda_alg.QKmeans - 量子K-means聚类
            - pyqpanda_alg.QSEncode - 量子状态编码
            - pyqpanda_alg.plugin - 插件系统

            ## 重新构建
            如需重新构建文档，请运行:
            \`\`\`bash
            cd Tutorials/source
            sphinx-build -b html ./ ./build/
            \`\`\`
            EOF

            echo "✅ 文档打包完成"
            echo "输出目录结构:"
            ls -lh output/docs/
            echo ""
            echo "HTML文档示例:"
            ls -lh output/docs/html/*.html | head -5
        artifacts:
          - name: documentation_html
            path:
              - output/docs/
  - name: automated_testing
    displayName: 自动化测试
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: run_tests
        displayName: 运行单元测试
        pythonVersion: '3.10'
        commands:
          - |
            set -e
            echo "开始自动化测试"

            # 创建虚拟环境
            python3 -m venv /tmp/alg-test-venv
            source /tmp/alg-test-venv/bin/activate

            # 检查已构建的wheel包
            WHEEL_FOUND=false
            if [ -d "output/linux/3.10" ] && [ -n "$(ls output/linux/3.10/*.whl 2>/dev/null)" ]; then
              WHEEL_FILE=$(ls output/linux/3.10/*.whl | head -1)
              WHEEL_FOUND=true
            elif [ -d "output" ] && find output -name "*.whl" -type f | grep -q .; then
              WHEEL_FILE=$(find output -name "*.whl" -type f | head -1)
              WHEEL_FOUND=true
            fi

            if [ "$WHEEL_FOUND" = true ]; then
              echo "安装wheel包: $WHEEL_FILE"
              pip install "$WHEEL_FILE"
            else
              if [ -f "pyqpanda-algorithm/setup.py" ]; then
                cd pyqpanda-algorithm
                pip install -e .
                cd ..
              else
                echo "❌ 错误: 未找到wheel包且没有setup.py"
                exit 1
              fi
            fi

            # 安装项目依赖
            pip install numpy scipy sympy

            if [ -f "pyqpanda-algorithm/requirements.txt" ]; then
              pip install -r pyqpanda-algorithm/requirements.txt
            fi

            # 安装测试依赖
            pip install pytest allure-pytest pytest-html pytest-rerunfailures pytest-xdist

            # 检查测试目录
            if [ ! -d "test" ]; then
              echo "❌ 错误: test 目录不存在"
              exit 1
            fi

            # 进入测试目录
            cd test

            # 创建测试输出目录
            mkdir -p ../output/test_results
            mkdir -p ../output/test_results/allure-results
            mkdir -p ../output/test_results/html-report

            # 运行测试
            echo "运行单元测试..."
            pytest -v \
              --junitxml=../output/test_results/junit-results.xml \
              --alluredir=../output/test_results/allure-results \
              --clean-alluredir \
              --tb=short \
              --disable-warnings \
              --maxfail=5 \
              || true

            # 生成HTML报告
            echo "生成HTML报告..."
            pytest -v \
              --html=../output/test_results/html-report/report.html \
              --self-contained-html \
              --tb=short \
              --disable-warnings \
              --maxfail=5 \
              || true

            # 生成Allure报告（如果有结果）
            if [ -d "../output/test_results/allure-results" ] && [ -n "$(ls -A ../output/test_results/allure-results 2>/dev/null)" ]; then
              echo "生成Allure报告..."
              pip install allure-python-commons
              
              if python -m allure --version &> /dev/null; then
                python -m allure generate ../output/test_results/allure-results -o ../output/test_results/allure-report --clean
              fi
            fi

            cd ..
            echo "✅ 自动化测试完成"
        artifacts:
          - name: test_results
            path:
              - output/test_results/
  - name: package
    displayName: 打包所有产物
    strategy: naturally
    trigger: auto
    steps:
      - step: build@python
        name: create_release_package
        displayName: 创建发布包
        pythonVersion: '3.10'
        commands:
          - |
            echo "========== 打包所有构建产物 =========="

            # 创建发布目录
            mkdir -p release_package/wheels
            mkdir -p release_package/docs
            mkdir -p release_package/test_reports

            # 复制所有wheel文件到发布目录
            echo "收集所有平台的wheel文件..."
            if [ -d "output" ]; then
              # 复制wheel文件
              find output/linux -name "*.whl" -type f -exec cp {} release_package/wheels/ \;
              find output/windows -name "*.whl" -type f -exec cp {} release_package/wheels/ \;
              find output/macos -name "*.whl" -type f -exec cp {} release_package/wheels/ \;
              
              # 复制文档
              if [ -d "output/docs" ]; then
                cp -r output/docs/* release_package/docs/
              fi
              
              # 复制测试结果
              if [ -d "output/test_results" ]; then
                cp -r output/test_results/* release_package/test_reports/
              fi
            fi

            # 创建README文件
            cat > release_package/README.md << EOF
            # PyQPanda Algorithm 多平台多版本发布包

            ## 支持的平台和Python版本

            | 平台 | Python版本 | 架构 | 备注 |
            |------|------------|------|------|
            | Linux | 3.10, 3.11, 3.12 | x86_64 | 在CentOS环境中构建 |
            | Windows | 3.10, 3.11, 3.12 | AMD64 | 在CentOS中构建的纯Python包 |
            | macOS | 3.10, 3.11, 3.12 | ARM64 | 在CentOS中构建的macOS格式包 |

            ## 包含内容
            1. **Wheel包** (\`wheels/\` 目录)
               - 所有平台的预编译包
               - 按平台和Python版本分类

            2. **项目文档** (\`docs/\` 目录)
               - 完整的API文档
               - HTML格式，可直接在浏览器中查看
               - 打开 \`docs/html/index.html\` 开始浏览

            3. **测试报告** (\`test_reports/\` 目录)
               - 自动化测试结果
               - JUnit格式报告
               - HTML可视化报告
               - Allure高级报告

            ## 重要说明
            1. **所有包均在CentOS环境中构建**
            2. **Windows和macOS包仅为平台标签重命名，如果包含平台特定代码，需要在对应平台重新构建**
            3. **文档使用Sphinx自动生成，包含完整的API参考**
            4. **测试报告包含完整的单元测试执行结果**

            ## 文件命名规范
            - Linux: \`包名-版本-cp{版本号}-cp{版本号}-manylinux2014_x86_64.whl\`
            - Windows: \`包名-版本-cp{版本号}-cp{版本号}-win_amd64.whl\`
            - macOS: \`包名-版本-cp{版本号}-cp{版本号}-macosx_11_0_arm64.whl\`

            ## 使用说明
            \`\`\`bash
            # 根据您的平台和Python版本选择合适的文件
            pip install wheels/your_package-*.whl

            # 查看文档
            # 打开 docs/html/index.html 在浏览器中查看

            # 查看测试报告
            # 打开 test_reports/html-report/report.html 查看测试结果
            \`\`\`

            ## 构建环境
            - 构建系统: CentOS
            - 构建时间: \$(date)
            - 总包数量: \$(ls -1 release_package/wheels/*.whl 2>/dev/null | wc -l 2>/dev/null || echo "0")
            - 文档版本: \$(sphinx-build --version 2>&1 | head -1 2>/dev/null || echo "Sphinx")
            - 测试框架: pytest $(pytest --version 2>&1)
            EOF

            # 创建目录结构说明
            cat > release_package/DIRECTORY_STRUCTURE.md << EOF
            # 目录结构

            release_package/
            ├── README.md              # 本文件
            ├── DIRECTORY_STRUCTURE.md # 目录结构说明
            ├── wheels/                # 所有平台的Wheel包
            │   ├── linux_3.10_*.whl
            │   ├── linux_3.11_*.whl
            │   ├── linux_3.12_*.whl
            │   ├── windows_3.10_*.whl
            │   ├── windows_3.11_*.whl
            │   ├── windows_3.12_*.whl
            │   ├── macos_3.10_*.whl
            │   ├── macos_3.11_*.whl
            │   └── macos_3.12_*.whl
            ├── docs/                  # 项目文档
            │   ├── README.md          # 文档说明
            │   └── html/              # HTML文档
            │       ├── index.html     # 文档首页
            │       ├── *.html         # 其他页面
            │       └── _static/       # 静态资源
            └── test_reports/          # 测试报告
                ├── README.md          # 测试报告说明
                ├── junit-results.xml  # JUnit格式测试结果
                ├── html-report/       # HTML测试报告
                │   └── report.html    # HTML测试报告
                ├── allure-results/    # Allure原始数据
                └── allure-report/     # Allure测试报告(如生成)
            EOF

            echo "✅ 打包完成"
            echo "发布包内容:"
            ls -lh release_package/
            echo ""
            echo "Wheel包:"
            ls -lh release_package/wheels/ 2>/dev/null || echo "无wheel包"
            echo ""
            echo "文档:"
            ls -lh release_package/docs/ 2>/dev/null || echo "无文档"
            echo ""
            echo "测试报告:"
            ls -lh release_package/test_reports/ 2>/dev/null || echo "无测试报告"
        artifacts:
          - name: all_wheels
            path:
              - release_package/
